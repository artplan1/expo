"use strict";var Y=Object.create;var V=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var ne=Object.getPrototypeOf,re=Object.prototype.hasOwnProperty;var oe=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of te(t))!re.call(e,i)&&i!==n&&V(e,i,{get:()=>t[i],enumerable:!(o=ee(t,i))||o.enumerable});return e};var se=(e,t,n)=>(n=e!=null?Y(ne(e)):{},oe(t||!e||!e.__esModule?V(n,"default",{value:e,enumerable:!0}):n,e));Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const ie=require("react/jsx-runtime"),G=require("@kinde/jwt-validator"),P=require("expo-auth-session"),ae=require("expo-web-browser"),b=require("react"),ce=require("expo-constants");var E=(e=>(e.none="none",e.create="create",e.login="login",e))(E||{});const K=e=>e.replace(/\/$/,""),Z=(e,t=!1)=>{const n={login_hint:e.loginHint,is_create_org:e.isCreateOrg?.toString(),connection_id:e.connectionId,redirect_uri:e.redirectURL?t?e.redirectURL:K(e.redirectURL):void 0,audience:e.audience||"",scope:e.scope?.join(" ")||"email profile openid offline",prompt:e.prompt,lang:e.lang,org_code:e.orgCode,org_name:e.orgName,has_success_page:e.hasSuccessPage?.toString(),workflow_deployment_id:e.workflowDeploymentId};return Object.keys(n).forEach(o=>n[o]===void 0&&delete n[o]),n};let x;function N(e,t){if(z(),typeof window>"u")throw new Error("setRefreshTimer requires a browser environment");if(e<=0)throw new Error("Timer duration must be positive");x=window.setTimeout(t,e*1e3-1e4)}function z(){x!==void 0&&(window.clearTimeout(x),x=void 0)}function ue(e,t){if(!e)return null;const n=e.split(".");if(n.length!==3)return null;const o=n[1].replace(/-/g,"+").replace(/_/g,"/"),i=decodeURIComponent(atob(o).split("").map(g=>"%"+("00"+g.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(i)}var c=(e=>(e.accessToken="accessToken",e.idToken="idToken",e.refreshToken="refreshToken",e.state="state",e.nonce="nonce",e.codeVerifier="codeVerifier",e))(c||{});class de{async setItems(t){await Promise.all(Object.entries(t).map(([n,o])=>this.setSessionItem(n,o)))}async removeItems(...t){await Promise.all(t.map(n=>this.removeSessionItem(n)))}}function le(e,t){return t<=0?[]:e.match(new RegExp(`.{1,${t}}`,"g"))||[]}let v;async function j(){let e=0;for(;!v&&e<20;)await new Promise(t=>setTimeout(t,100)),e++}class B extends de{constructor(){super(),this.loadExpoStore()}async loadExpoStore(){try{v=await import("expo-secure-store")}catch(t){console.error("Error loading dependency expo storage:",t)}}async destroySession(){Object.values(c).forEach(async t=>{await this.removeSessionItem(t)})}async setSessionItem(t,n){if(await j(),await this.removeSessionItem(t),typeof n=="string"){le(n,Math.min(y.maxLength,2048)).forEach(async(o,i)=>{await v.setItemAsync(`${y.keyPrefix}${t}${i}`,o)});return}else throw new Error("Item value must be a string")}async getSessionItem(t){await j();const n=[];let o=0,i=await v.getItemAsync(`${y.keyPrefix}${String(t)}${o}`);for(;i;)n.push(i),o++,i=await v.getItemAsync(`${y.keyPrefix}${String(t)}${o}`);return n.join("")||null}async removeSessionItem(t){await j();let n=0,o=await v.getItemAsync(`${y.keyPrefix}${String(t)}${n}`);for(;o;)await v.deleteItemAsync(`${y.keyPrefix}${String(t)}${n}`),n++,o=await v.getItemAsync(`${y.keyPrefix}${String(t)}${n}`)}}const y={keyPrefix:"kinde-",maxLength:2e3,useInsecureForRefreshToken:!1},I=async(e=c.accessToken)=>{const t=$();if(!t)return null;const n=await t.getSessionItem(e==="accessToken"?c.accessToken:c.idToken);if(!n)return null;const o=ue(n);return o||console.warn("No decoded token found"),o},F=async(e="accessToken")=>I(e),q=async(e,t="accessToken")=>{const n=await F(t);return n?{name:e,value:n[e]}:null},fe=async()=>(await q("org_code"))?.value||null,ge=async e=>{const t=(await q("feature_flags"))?.value;if(e&&t){const n=t[e];return n?n?.v:null}return null},he=async()=>{const e=await F("idToken");if(!e)return null;const{sub:t}=e;return t?{id:e.sub,givenName:e.given_name,familyName:e.family_name,email:e.email,picture:e.picture}:(console.error("No sub in idToken"),null)},me=async e=>{const t=await I();if(!t)return{permissionKey:e,orgCode:null,isGranted:!1};const n=t.permissions||[];return{permissionKey:e,orgCode:t.org_code,isGranted:!!n.includes(e)}},we=async()=>{const e=await I();if(!e)return{orgCode:null,permissions:[]};const t=e.permissions||[];return{orgCode:e.org_code,permissions:t}},pe=async()=>(await I("idToken"))?.org_codes||null,ke=async()=>{const e=await I();return e?e.roles?e.roles:(console.warn("No roles found in token, ensure roles have been included in the token customisation within the application settings"),[]):[]},L={secure:null,insecure:null},J=e=>{L.secure=e},$=()=>L.secure||null,W=()=>L.secure||null,D=async({domain:e,clientId:t,refreshType:n=0})=>{try{if(!e)return{success:!1,error:"Domain is required for token refresh"};if(!t)return{success:!1,error:"Client ID is required for token refresh"};let o="",i;if(y.useInsecureForRefreshToken||!X(e)?i=W():i=$(),n===0){if(!i)return{success:!1,error:"No active storage found"};if(o=await i.getSessionItem(c.refreshToken),!o)return{success:!1,error:"No refresh token found"}}z();try{const g=await fetch(`${K(e)}/oauth2/token`,{method:"POST",...n===1&&{credentials:"include"},headers:{"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:new URLSearchParams({...n===0&&{refresh_token:o},grant_type:"refresh_token",client_id:t})});if(!g.ok)return{success:!1,error:"Failed to refresh token"};const u=await g.json();if(u.access_token){const m=$();return m?(N(u.expires_in,async()=>{D({domain:e,clientId:t,refreshType:n})}),i&&(await m.setSessionItem(c.accessToken,u.access_token),u.id_token&&await m.setSessionItem(c.idToken,u.id_token),u.refresh_token&&await i.setSessionItem(c.refreshToken,u.refresh_token)),{success:!0,[c.accessToken]:u.access_token,[c.idToken]:u.id_token,[c.refreshToken]:u.refresh_token}):{success:!1,error:"No active storage found"}}}catch(g){return{success:!1,error:`No access token recieved: ${g}`}}return{success:!1,error:"No access token recieved"}}catch(o){return{success:!1,error:`Error refreshing token: ${o.message}`}}},X=e=>!e.match(/^(?:https?:\/\/)?[a-zA-Z0-9][.-a-zA-Z0-9]*\.kinde\.com$/i),k=Object.freeze(Object.defineProperty({__proto__:null,ExpoSecureStore:B,PromptTypes:E,StorageKeys:c,clearRefreshTimer:z,getActiveStorage:$,getClaim:q,getClaims:F,getCurrentOrganization:fe,getDecodedToken:I,getFlag:ge,getInsecureStorage:W,getPermission:me,getPermissions:we,getRoles:ke,getUserOrganizations:pe,getUserProfile:he,isCustomDomain:X,mapLoginMethodParamsForUrl:Z,refreshToken:D,sanitizeUrl:K,setActiveStorage:J,setRefreshTimer:N,storageSettings:y},Symbol.toStringTag,{value:"Module"})),ye="openid profile email offline";function ve(e,t){if(!e)return null;const n=e.split(".");if(n.length!==3)return null;const o=n[1].replace(/-/g,"+").replace(/_/g,"/"),i=decodeURIComponent(atob(o).split("").map(g=>"%"+("00"+g.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(i)}var Te=typeof globalThis<"u"?globalThis:typeof window<"u"||typeof window<"u"?window:typeof self<"u"?self:{},R={exports:{}};/*! https://mths.be/base64 v1.0.0 by @mathias | MIT license */R.exports;(function(e,t){(function(n){var o=t,i=e&&e.exports==o&&e,g=typeof window=="object"&&window;(g.global===g||g.window===g)&&(n=g);var u=function(a){this.message=a};u.prototype=new Error,u.prototype.name="InvalidCharacterError";var m=function(a){throw new u(a)},h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",C=/[\t\n\f\r ]/g,U=function(a){a=String(a).replace(C,"");var w=a.length;w%4==0&&(a=a.replace(/==?$/,""),w=a.length),(w%4==1||/[^+a-zA-Z0-9/]/.test(a))&&m("Invalid character: the string to be decoded is not correctly encoded.");for(var p=0,r,s,d="",l=-1;++l<w;)s=h.indexOf(a.charAt(l)),r=p%4?r*64+s:s,p++%4&&(d+=String.fromCharCode(255&r>>(-2*p&6)));return d},O=function(a){a=String(a),/[^\0-\xFF]/.test(a)&&m("The string to be encoded contains characters outside of the Latin1 range.");for(var w=a.length%3,p="",r=-1,s,d,l,f,_=a.length-w;++r<_;)s=a.charCodeAt(r)<<16,d=a.charCodeAt(++r)<<8,l=a.charCodeAt(++r),f=s+d+l,p+=h.charAt(f>>18&63)+h.charAt(f>>12&63)+h.charAt(f>>6&63)+h.charAt(f&63);return w==2?(s=a.charCodeAt(r)<<8,d=a.charCodeAt(++r),f=s+d,p+=h.charAt(f>>10)+h.charAt(f>>4&63)+h.charAt(f<<2&63)+"="):w==1&&(f=a.charCodeAt(r),p+=h.charAt(f>>2)+h.charAt(f<<4&63)+"=="),p},A={encode:O,decode:U,version:"1.0.0"};if(o&&!o.nodeType)if(i)i.exports=A;else for(var S in A)A.hasOwnProperty(S)&&(o[S]=A[S]);else n.base64=A})(Te)})(R,R.exports);var H=R.exports;const M=b.createContext(void 0);typeof window<"u"&&(window.btoa=H.encode,window.atob=H.decode);const T=new B;J(T);const Ae=({children:e,config:t})=>{const n=t.domain;if(n===void 0)throw new Error("KindeAuthProvider config.domain prop is undefined");const o=t.clientId;if(o===void 0)throw new Error("KindeAuthProvider config.clientId prop is undefined");const i=t.scopes?.split(" ")||ye.split(" "),[g,u]=b.useState(!1),m=P.makeRedirectUri({native:ce.isDevice}),h={authorizationEndpoint:`${n}/oauth2/auth`,tokenEndpoint:`${n}/oauth2/token`,endSessionEndpoint:`${n}/logout`,userInfoEndpoint:`${n}/oauth2/v2/user_profile`,revocationEndpoint:`${n}/oauth2/revoke`};b.useEffect(()=>{(async()=>{await S()&&u(!0)})()},[]);const C=async(r={})=>{if(!m)return{success:!1,errorMessage:"This library only works on a mobile device"};const s=new P.AuthRequest({clientId:o,redirectUri:m,scopes:i,extraParams:{...Z(r),has_success_page:"true"}});try{const d=await s.promptAsync({authorizationEndpoint:`${n}/oauth2/auth`},{showInRecents:!0});if(s&&d?.type==="success"){const l=await P.exchangeCodeAsync({clientId:o,code:d.params.code,extraParams:s.codeVerifier?{code_verifier:s.codeVerifier}:void 0,redirectUri:m},{tokenEndpoint:`${n}/oauth2/token`});if(l.idToken){const _=await G.validateToken({token:l.idToken,domain:n});_.valid?T.setSessionItem(c.idToken,l.idToken):console.error("Invalid id token",_.message)}const f=await G.validateToken({token:l.accessToken,domain:n});return f.valid?(T.setSessionItem(c.accessToken,l.accessToken),u(!0)):console.error("Invalid access token",f.message),T.setSessionItem(c.refreshToken,l.refreshToken),N(l.expiresIn||60,async()=>{D({domain:n,clientId:o})}),{success:!0,accessToken:l.accessToken,idToken:l.idToken}}return{success:!1,errorMessage:"Unknown error"}}catch(d){return console.error(d),{success:!1,errorMessage:d.message}}},U=async(r={})=>C({...r,prompt:E.login}),O=async(r={})=>C({...r,prompt:E.create});async function A({revokeToken:r}={}){const s=async()=>{await T.removeItems(c.accessToken,c.idToken),u(!1)};return new Promise(async d=>{const l=await T.getSessionItem(c.accessToken);l&&h&&(r?P.revokeAsync({token:l,tokenTypeHint:P.TokenTypeHint.AccessToken},h).then(async()=>{await s(),d({success:!0})}).catch(f=>{console.error(f),d({success:!1})}):(await ae.openAuthSessionAsync(`${h?.endSessionEndpoint}?redirect=${m}`),await s(),d({success:!0}))),d({success:!0})})}async function S(){return await T.getSessionItem(c.accessToken)}async function a(){return await T.getSessionItem(c.idToken)}async function w(r="accessToken"){const s=r==="accessToken"?await S():await a();return s?ve(s):null}const p={login:U,logout:A,register:O,getAccessToken:S,getIdToken:a,getDecodedToken:w,getClaim:async(...r)=>{const{getClaim:s}=await Promise.resolve().then(()=>k);return s(...r)},getClaims:async(...r)=>{const{getClaims:s}=await Promise.resolve().then(()=>k);return s(...r)},getCurrentOrganization:async(...r)=>{const{getCurrentOrganization:s}=await Promise.resolve().then(()=>k);return s(...r)},getFlag:async(...r)=>{const{getFlag:s}=await Promise.resolve().then(()=>k);return s(...r)},getUserProfile:async(...r)=>{const{getUserProfile:s}=await Promise.resolve().then(()=>k);return s(...r)},getPermission:async(...r)=>{const{getPermission:s}=await Promise.resolve().then(()=>k);return s(...r)},getPermissions:async(...r)=>{const{getPermissions:s}=await Promise.resolve().then(()=>k);return s(...r)},getUserOrganizations:async(...r)=>{const{getUserOrganizations:s}=await Promise.resolve().then(()=>k);return s(...r)},getRoles:async(...r)=>{const{getRoles:s}=await Promise.resolve().then(()=>k);return s(...r)},isAuthenticated:g};return ie.jsx(M.Provider,{value:p,children:e})},Q=()=>{const e=b.useContext(M);if(!e)throw new Error("useKindeAuth must be used within a KindeAuthProvider");return e},Se=()=>Q();exports.KindeAuthContext=M;exports.KindeAuthProvider=Ae;exports.useKindeAuth=Se;exports.useKindeAuthContext=Q;
